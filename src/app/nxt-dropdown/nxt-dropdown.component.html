<div class="nxt-dropdown-container" 
     [class.disabled]="isDisabled"
     [class.open]="isOpen"
     [class.required]="required"
     [class.multiple]="multiple"
     [class.infield-label]="infieldLabel"
     [class.infield-label-onfield]="infieldLabel && infieldLabelPosition === 'onfield'"
     [class.infield-label-infield]="infieldLabel && infieldLabelPosition === 'infield'"
     [class.floatlabel-enabled]="floatlabel"
     [class.floatlabel-infield-enabled]="floatlabel && floatlabelPosition === 'infield'"
     [class.floatlabel-onfield-enabled]="floatlabel && floatlabelPosition === 'onfield'">
  
  <!-- Custom Trigger -->
  <div *ngIf="hasCustomTrigger" class="nxt-dropdown-custom-trigger-wrapper">
    <ng-content select="nxt-dropdown-trigger"></ng-content>
  </div>
  
  <!-- Default Trigger -->
  <div class="nxt-dropdown-trigger" 
       *ngIf="!hasCustomTrigger"
       [class.infield-label-mode]="infieldLabel"
       (click)="toggleDropdown()"
       (keydown)="onKeyDown($event)"
       tabindex="0"
       role="combobox"
       [attr.aria-expanded]="isOpen"
       [attr.aria-haspopup]="true"
       [attr.aria-label]="placeholder">
    
    <!-- Labels -->
    <ng-container *ngIf="infieldLabel">
      <div class="nxt-dropdown-infield-label" 
           *ngIf="infieldLabelPosition === 'infield'"
           [class.active]="isOpen || selectedOptions.length > 0">
        {{ getInfieldLabelText() }}
      </div>
      
      <div class="nxt-dropdown-onfield-label" 
           *ngIf="infieldLabelPosition === 'onfield'">
        {{ getInfieldLabelText() }}
      </div>
    </ng-container>

    <ng-container *ngIf="floatlabel">
      <div class="nxt-dropdown-float-infield-label" 
           *ngIf="floatlabelPosition === 'infield'"
           [class.active]="isOpen || selectedOptions.length > 0">
        {{ getFloatLabelText() }}
      </div>
      
      <div class="nxt-dropdown-float-onfield-label" 
           *ngIf="floatlabelPosition === 'onfield'"
           [class.active]="isOpen || selectedOptions.length > 0">
        {{ getFloatLabelText() }}
      </div>
    </ng-container>
    
    <!-- Value Display -->
    <div class="nxt-dropdown-value" 
         [class.infield-label-mode]="infieldLabel"
         [class.infield-label-infield-mode]="infieldLabel && infieldLabelPosition === 'infield'"
         [class.floatlabel-infield-mode]="floatlabel && floatlabelPosition === 'infield'"
         [class.floatlabel-infield-active]="floatlabel && floatlabelPosition === 'infield' && (selectedOptions.length > 0)"
         [class.no-height]="floatlabel && selectedOptions.length === 0">
      
      <ng-container *ngIf="selectedOptions.length === 0; else selectedContent">
        <div class="nxt-dropdown-placeholder">{{ placeholder }}</div>
      </ng-container>
      
      <ng-template #selectedContent>
        <div class="nxt-dropdown-selected">
          <div class="nxt-dropdown-single" *ngIf="!multiple">
            {{ getDisplayText() }}
          </div>
          
          <div class="nxt-dropdown-multiple" *ngIf="multiple">
            <div class="nxt-dropdown-text">{{ getDisplayText() }}</div>
          </div>
        </div>
      </ng-template>
    </div>
    
    <!-- Arrow Icon -->
    <div class="nxt-dropdown-arrow">
      <svg [attr.data-icon-type]="iconType" width="12" height="12" viewBox="0 0 12 12" fill="none">
        <!-- Caret -->
        <path *ngIf="iconType === 'caret'" 
              d="M3 4.5L6 7.5L9 4.5" 
              stroke="currentColor" 
              stroke-width="1.5" 
              stroke-linecap="round" 
              stroke-linejoin="round"/>
        
        <!-- Arrow -->
        <path *ngIf="iconType === 'arrow'" 
              d="M6 2L6 10M6 10L3 7M6 10L9 7" 
              stroke="currentColor" 
              stroke-width="1.5" 
              stroke-linecap="round" 
              stroke-linejoin="round"/>
        
        <!-- Sharp Caret -->
        <polygon *ngIf="iconType === 'sharp-caret'" 
                 points="3,4.5 6,7.5 9,4.5" 
                 fill="currentColor"/>
        
        <!-- Inverted Triangle -->
        <polygon *ngIf="iconType === 'inverted-triangle'" 
                 points="2,3 6,9 10,3" 
                 fill="currentColor"/>
      </svg>
    </div>
  </div>
  
  <!-- Dropdown Panel -->
  <div class="nxt-dropdown-dropdown" 
       *ngIf="isOpen"
       [class]="panelClass"
       [class.confirmation-mode]="confirmation && multiple"
       [class.position-above]="shouldPositionAbove">
    
    <!-- Search Input -->
    <div class="nxt-dropdown-search" *ngIf="searchable && showSearchInput">
      <div class="nxt-dropdown-search-container">
        <div class="nxt-dropdown-option nxt-dropdown-all-option beside-select-all"
        *ngIf="(selectAllPosition === 'beside') && multiple && options.length > 0"
        [class.selected]="isAllAvailableSelected()"
        [class.partially-selected]="isPartiallyAvailableSelected()"
        (click)="selectAll(); $event.stopPropagation()"
        role="option"
        [attr.aria-selected]="isAllAvailableSelected()">
     
          <div class="nxt-dropdown-option-content">
            <div class="nxt-dropdown-option-checkbox">
              <div class="nxt-dropdown-checkbox" 
                    [class.checked]="isAllAvailableSelected()"
                    [class.partially]="isPartiallyAvailableSelected()">
                <svg *ngIf="isAllAvailableSelected()" width="12" height="12" viewBox="0 0 12 12" fill="none">
                  <path d="M2 6L5 9L10 3" 
                        stroke="white" 
                        stroke-width="2" 
                        stroke-linecap="round" 
                        stroke-linejoin="round"/>
                </svg>
                <svg *ngIf="isPartiallyAvailableSelected()" width="12" height="12" viewBox="0 0 12 12" fill="none">
                  <path d="M3 6H9" 
                        stroke="white" 
                        stroke-width="2" 
                        stroke-linecap="round"/>
                </svg>
              </div>
            </div>
          </div>
        </div>
        <input type="text"
               class="nxt-dropdown-search-input"
               [placeholder]="searchPlaceholder"
               [value]="searchText"
               (input)="onSearchInput($event)"
               (keydown)="onSearchKeyDown($event)"
               autocomplete="off"
               spellcheck="false">
        <button type="button" 
                class="nxt-dropdown-search-clear"
                *ngIf="searchText"
                (click)="clearSearch(); $event.stopPropagation()"
                aria-label="Clear search">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" style="width: 24px; height: 24px;">
            <path d="M18 6L6 18M6 6L18 18" 
                  stroke="currentColor" 
                  stroke-width="1.5" 
                  stroke-linecap="round" 
                  stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>

    <!-- Options Container -->
    <div class="nxt-dropdown-options">
      <!-- Select All Option -->
      <div class="nxt-dropdown-option nxt-dropdown-all-option"
           *ngIf="(selectAllPosition === 'below') && multiple && options.length > 0"
           [class.selected]="isAllAvailableSelected()"
           [class.partially-selected]="isPartiallyAvailableSelected()"
           (click)="selectAll(); $event.stopPropagation()"
           role="option"
           [attr.aria-selected]="isAllAvailableSelected()">
        
        <div class="nxt-dropdown-option-content">
                      <div class="nxt-dropdown-option-checkbox">
              <div class="nxt-dropdown-checkbox" 
                   [class.checked]="isAllAvailableSelected()"
                   [class.partially]="isPartiallyAvailableSelected()">
                <svg *ngIf="isAllAvailableSelected()" width="12" height="12" viewBox="0 0 12 12" fill="none">
                  <path d="M2 6L5 9L10 3" 
                        stroke="white" 
                        stroke-width="2" 
                        stroke-linecap="round" 
                        stroke-linejoin="round"/>
                </svg>
                <svg *ngIf="isPartiallyAvailableSelected()" width="12" height="12" viewBox="0 0 12 12" fill="none">
                  <path d="M3 6H9" 
                        stroke="white" 
                        stroke-width="2" 
                        stroke-linecap="round"/>
                </svg>
              </div>
            </div>
          
          <div class="nxt-dropdown-option-label">
            <strong>Select All</strong>
          </div>
        </div>
      </div>

      <!-- Divider -->
      <div class="nxt-dropdown-divider" *ngIf="(selectAllPosition === 'below') && multiple && options.length > 0"></div>
      
      <!-- Options -->
      <ng-container *ngFor="let option of filteredOptions; let i = index; trackBy: trackByValue">
        <!-- Group Header -->
        <div class="nxt-dropdown-group-header" 
             *ngIf="option.group && shouldShowGroupHeader(option, i)">
          {{ option.group }}
        </div>
        
        <!-- Option -->
        <div class="nxt-dropdown-option"
             [class.selected]="isOptionSelected(option)"
             [class.disabled]="option.disabled"
             [class.grouped]="option.group"
             (click)="selectOption(option); $event.stopPropagation()"
             role="option"
             [attr.aria-selected]="isOptionSelected(option)">
          
          <div class="nxt-dropdown-option-content">
            <div class="nxt-dropdown-option-checkbox" *ngIf="multiple">
              <div class="nxt-dropdown-checkbox" [class.checked]="isOptionSelected(option)">
                <svg *ngIf="isOptionSelected(option)" width="12" height="12" viewBox="0 0 12 12" fill="none">
                  <path d="M2 6L5 9L10 3" 
                        stroke="white" 
                        stroke-width="2" 
                        stroke-linecap="round" 
                        stroke-linejoin="round"/>
                </svg>
              </div>
            </div>
            
            <div class="nxt-dropdown-option-label">
              {{ option.label }}
            </div>
          </div>
        </div>
      </ng-container>
      
      <!-- No Options Message -->
      <div class="nxt-dropdown-no-options" *ngIf="filteredOptions.length === 0">
        <div *ngIf="searchable && searchText && searchText.length >= minSearchLength">
          No options found for "{{ searchText }}"
        </div>
        <div *ngIf="!searchable || !searchText || searchText.length < minSearchLength">
          No options available
        </div>
      </div>
    </div>

    <!-- Confirmation Footer -->
    <div class="nxt-dropdown-footer" *ngIf="confirmation && multiple">
      <div class="nxt-dropdown-footer-buttons">
        <button type="button" 
                class="nxt-dropdown-btn nxt-dropdown-btn-cancel"
                (click)="cancelSelection(); $event.stopPropagation()">
          <span *ngIf="cancelButtonIcon" 
                class="nxt-dropdown-btn-icon" 
                [innerHTML]="getSanitizedIcon(cancelButtonIcon)"></span>
          {{ cancelButtonText }}
        </button>
        <button type="button" 
                class="nxt-dropdown-btn nxt-dropdown-btn-apply"
                (click)="applySelection(); $event.stopPropagation()">
          <span *ngIf="applyButtonIcon" 
                class="nxt-dropdown-btn-icon" 
                [innerHTML]="getSanitizedIcon(applyButtonIcon)"></span>
          {{ applyButtonText }}
        </button>
      </div>
    </div>
  </div>
  
  <!-- Error Message -->
  <div class="nxt-dropdown-error" *ngIf="required && !value">
    This field is required
  </div>
</div> 